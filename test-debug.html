<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blinko åœ°ç†ä½ç½®è°ƒè¯•å·¥å…·</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    h2 {
      color: #666;
      margin-top: 30px;
      margin-bottom: 15px;
      font-size: 18px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
      font-size: 14px;
    }
    button:hover {
      background: #0056b3;
    }
    button:active {
      transform: scale(0.98);
    }
    #console-output {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #007bff;
      padding-left: 10px;
    }
    .log-error {
      border-left-color: #ff4444;
      background: rgba(255, 68, 68, 0.1);
    }
    .log-success {
      border-left-color: #00cc66;
      background: rgba(0, 204, 102, 0.1);
    }
    .info-box {
      background: #e7f3ff;
      border-left: 4px solid #2196f3;
      padding: 15px;
      margin: 15px 0;
      border-radius: 4px;
    }
    .iframe-container {
      width: 100%;
      height: 600px;
      border: 2px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
    }
    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” Blinko åœ°ç†ä½ç½®åŠŸèƒ½è°ƒè¯•å·¥å…·</h1>

    <div class="info-box">
      <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong>
      <ol>
        <li>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ‰§è¡Œè°ƒè¯•æ“ä½œ</li>
        <li>è§‚å¯Ÿæ§åˆ¶å°è¾“å‡º</li>
        <li>åœ¨åµŒå…¥å¼æµè§ˆå™¨ä¸­æµ‹è¯•åœ°ç†ä½ç½®åŠŸèƒ½</li>
      </ol>
    </div>

    <h2>è°ƒè¯•æ“ä½œ</h2>
    <button onclick="runDebug()">ğŸ” è¿è¡Œå®Œæ•´è°ƒè¯•</button>
    <button onclick="checkEditorStore()">ğŸ“¦ æ£€æŸ¥ç¼–è¾‘å™¨ Store</button>
    <button onclick="testInsertText()">âœï¸ æµ‹è¯•æ’å…¥æ–‡æœ¬</button>
    <button onclick="openLocationPicker()">ğŸ“ æ‰“å¼€ä½ç½®é€‰æ‹©å™¨</button>
    <button onclick="clearConsole()">ğŸ§¹ æ¸…ç©ºæ—¥å¿—</button>

    <h2>æ§åˆ¶å°è¾“å‡º</h2>
    <div id="console-output"></div>
  </div>

  <div class="container">
    <h2>åµŒå…¥å¼æµè§ˆå™¨</h2>
    <div class="iframe-container">
      <iframe id="blinko-frame" src="http://localhost:3000"></iframe>
    </div>
  </div>

  <script>
    let logs = [];

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const entry = { timestamp, message, type };
      logs.push(entry);

      const consoleOutput = document.getElementById('console-output');
      const entryDiv = document.createElement('div');
      entryDiv.className = `log-entry ${type === 'error' ? 'log-error' : type === 'success' ? 'log-success' : ''}`;
      entryDiv.textContent = `[${timestamp}] ${message}`;
      consoleOutput.appendChild(entryDiv);
      consoleOutput.scrollTop = consoleOutput.scrollHeight;
    }

    function clearConsole() {
      logs = [];
      document.getElementById('console-output').innerHTML = '';
      log('æ—¥å¿—å·²æ¸…ç©º');
    }

    function executeInIframe(code) {
      const iframe = document.getElementById('blinko-frame');
      try {
        return iframe.contentWindow.eval(code);
      } catch (error) {
        log(`iframeæ‰§è¡Œé”™è¯¯: ${error.message}`, 'error');
        return null;
      }
    }

    function runDebug() {
      log('å¼€å§‹å®Œæ•´è°ƒè¯•...', 'info');
      checkEditorStore();
      setTimeout(() => {
        log('è°ƒè¯•æ­¥éª¤ 2/3: æµ‹è¯•æ’å…¥æ–‡æœ¬...', 'info');
        testInsertText();
      }, 1000);
      setTimeout(() => {
        log('è°ƒè¯•æ­¥éª¤ 3/3: æ‰“å¼€ä½ç½®é€‰æ‹©å™¨...', 'info');
        openLocationPicker();
      }, 2000);
    }

    function checkEditorStore() {
      log('=== æ£€æŸ¥ç¼–è¾‘å™¨ Store ===');

      const result = executeInIframe(`
        (function() {
          const globalEditor = document.getElementById('global-editor');
          const result = {
            hasGlobalEditor: !!globalEditor,
            childrenCount: globalEditor ? globalEditor.children.length : 0,
            elementsWithStore: [],
            vditorFound: false
          };

          if (globalEditor) {
            for (let i = 0; i < globalEditor.children.length; i++) {
              const child = globalEditor.children[i];
              if (child.__storeInstance) {
                result.elementsWithStore.push({
                  index: i,
                  tagName: child.tagName,
                  className: child.className,
                  hasInsertMarkdown: typeof child.__storeInstance.insertMarkdown === 'function',
                  hasVditor: !!child.__storeInstance.vditor
                });
              }

              const allElements = child.querySelectorAll('*');
              allElements.forEach((el, idx) => {
                if (el.__storeInstance) {
                  result.elementsWithStore.push({
                    index: `descendant-${idx}`,
                    tagName: el.tagName,
                    className: el.className,
                    hasInsertMarkdown: typeof el.__storeInstance.insertMarkdown === 'function',
                    hasVditor: !!el.__storeInstance.vditor
                  });
                }
              });
            }
          }

          return JSON.stringify(result, null, 2);
        })()
      `);

      if (result) {
        const parsedResult = JSON.parse(result);
        log(`global-editor å­˜åœ¨: ${parsedResult.hasGlobalEditor}`);
        log(`å­å…ƒç´ æ•°é‡: ${parsedResult.childrenCount}`);
        log(`å¸¦æœ‰ __storeInstance çš„å…ƒç´ æ•°é‡: ${parsedResult.elementsWithStore.length}`);

        if (parsedResult.elementsWithStore.length > 0) {
          log('æ‰¾åˆ°çš„ Store å®ä¾‹:', 'success');
          parsedResult.elementsWithStore.forEach((el, idx) => {
            log(`  ${idx + 1}. ${el.tagName} [${el.className}]`, 'success');
            log(`     - æœ‰ insertMarkdown æ–¹æ³•: ${el.hasInsertMarkdown}`, 'success');
            log(`     - æœ‰ vditor: ${el.hasVditor}`, 'success');
          });
        } else {
          log('âŒ æœªæ‰¾åˆ°ä»»ä½•å¸¦æœ‰ __storeInstance çš„å…ƒç´ ï¼', 'error');
        }
      } else {
        log('âŒ æ— æ³•åœ¨ iframe ä¸­æ‰§è¡Œä»£ç ', 'error');
      }
    }

    function testInsertText() {
      log('=== æµ‹è¯•æ’å…¥æ–‡æœ¬åŠŸèƒ½ ===');

      const result = executeInIframe(`
        (function() {
          const globalEditor = document.getElementById('global-editor');
          if (!globalEditor) return { success: false, error: 'No global-editor' };

          let foundStore = null;
          const allElements = globalEditor.querySelectorAll('*');

          for (let el of allElements) {
            if (el.__storeInstance) {
              foundStore = el.__storeInstance;
              break;
            }
          }

          if (!foundStore) return { success: false, error: 'No storeInstance found' };

          const result = {
            hasStore: true,
            hasVditor: !!foundStore.vditor,
            hasInsertMarkdown: typeof foundStore.insertMarkdown === 'function',
            inserted: false
          };

          // å°è¯•æ’å…¥
          try {
            if (typeof foundStore.insertMarkdown === 'function') {
              foundStore.insertMarkdown('\\nğŸ“ æµ‹è¯•ä½ç½® - é€šè¿‡ insertMarkdown\\n');
              result.inserted = true;
              result.method = 'insertMarkdown';
            } else if (foundStore.vditor) {
              foundStore.vditor.insertValue('\\nğŸ“ æµ‹è¯•ä½ç½® - é€šè¿‡ vditor\\n');
              result.inserted = true;
              result.method = 'vditor.insertValue';
            }
          } catch (error) {
            result.error = error.message;
          }

          return JSON.stringify(result, null, 2);
        })()
      `);

      if (result) {
        const parsedResult = JSON.parse(result);
        if (parsedResult.success) {
          log('âœ… æ–‡æœ¬æ’å…¥æˆåŠŸï¼', 'success');
          log(`æ’å…¥æ–¹æ³•: ${parsedResult.method}`, 'success');
        } else {
          log(`âŒ æ–‡æœ¬æ’å…¥å¤±è´¥: ${parsedResult.error}`, 'error');
        }
      }
    }

    function openLocationPicker() {
      log('=== æ‰“å¼€ä½ç½®é€‰æ‹©å™¨ ===');

      const result = executeInIframe(`
        (function() {
          // å°è¯•è§¦å‘ eventBus äº‹ä»¶
          if (window.eventBus) {
            window.eventBus.emit('editor:openLocationPicker');
            return { success: true, method: 'eventBus' };
          } else {
            return { success: false, error: 'eventBus not found' };
          }
        })()
      `);

      if (result) {
        const parsedResult = JSON.parse(result);
        if (parsedResult.success) {
          log('âœ… å·²è§¦å‘æ‰“å¼€ä½ç½®é€‰æ‹©å™¨äº‹ä»¶', 'success');
          log('è¯·åœ¨åµŒå…¥å¼æµè§ˆå™¨ä¸­æŸ¥çœ‹æ˜¯å¦æ‰“å¼€äº†ä½ç½®é€‰æ‹©å™¨', 'info');
        } else {
          log(`âŒ æ— æ³•è§¦å‘äº‹ä»¶: ${parsedResult.error}`, 'error');
        }
      }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œä¸€æ¬¡æ£€æŸ¥
    window.onload = function() {
      setTimeout(() => {
        log('è°ƒè¯•å·¥å…·å·²åŠ è½½ï¼Œç­‰å¾… iframe å‡†å¤‡å°±ç»ª...', 'info');
        setTimeout(() => {
          log('iframe å·²å°±ç»ªï¼Œå¯ä»¥å¼€å§‹è°ƒè¯•', 'success');
        }, 2000);
      }, 1000);
    };
  </script>
</body>
</html>
