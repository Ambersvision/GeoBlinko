# ============================================
# Geoblinko PostgreSQL 优化配置
# ============================================
# 此文件针对中小型部署优化（4-8GB 内存，2-4 CPU）
# 请根据实际硬件配置调整

# ============================================
# 内存设置
# ============================================
# 共享缓冲区：PostgreSQL 最大的可配置内存区域
# 建议: 系统内存的 25%
# 4GB 内存 → 1GB, 8GB 内存 → 2GB
shared_buffers = '256MB'

# 工作内存：每个排序/哈希操作可用的内存
# 建议: 总内存的 2% (shared_buffers 的 1/32)
work_mem = '8MB'

# 维护工作内存：VACUUM、CREATE INDEX 等操作使用的内存
# 建议: work_mem 的 2-5 倍
maintenance_work_mem = '64MB'

# 有效缓存大小：估计可用于缓存的操作系统内存
# 建议: (总内存 - shared_buffers) - (系统预留 1-2GB)
# 8GB 内存 → 6GB, 4GB 内存 → 3GB
effective_cache_size = '2GB'

# ============================================
# 连接设置
# ============================================
# 最大连接数
max_connections = 100

# ============================================
# WAL (Write Ahead Log) 设置
# ============================================
# WAL 缓冲区
wal_buffers = '16MB'

# 最小 WAL 文件大小
min_wal_size = '1GB'

# 最大 WAL 文件大小
max_wal_size = '4GB'

# 检查点完成目标（0.5-1.0 之间）
checkpoint_completion_target = 0.9

# 检查点间隔（频繁检查点可减少恢复时间）
checkpoint_timeout = '15min'

# ============================================
# 查询优化
# ============================================
# 随机页面采样成本（SSD 建议设低值）
random_page_cost = 1.1

# 有效 I/O 并发度（SSD 建议增加）
effective_io_concurrency = 200

# ============================================
# 日志设置
# ============================================
# 日志目标
log_destination = 'stderr'

# 日志格式
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# 记录慢查询（超过 1 秒）
log_min_duration_statement = 1000

# 记录检查点
log_checkpoints = on

# 记录连接
log_connections = on

# 记录断开连接
log_disconnections = on

# ============================================
# 自动清理设置
# ============================================
# 自动清理阈值
autovacuum_analyze_threshold = 50
autovacuum_vacuum_threshold = 50

# 自动清理比例
autovacuum_analyze_scale_factor = 0.05
autovacuum_vacuum_scale_factor = 0.05

# 避免自动清理长时间运行
autovacuum_naptime = '10s'

# ============================================
# 其他优化
# ============================================
# 同步提交（off 提升性能，但有丢失最近事务风险）
# 生产环境建议: on（安全）或 local（平衡）
synchronous_commit = 'on'

# 默认统计目标（提高统计精度）
default_statistics_target = 100

# 约束排除延迟
constraint_exclusion = 'partition'

# ============================================
# 扩展配置
# ============================================
# 允许预加载扩展（性能优化）
shared_preload_libraries = ''

# ============================================
# 超时设置
# ============================================
# 语句超时（毫秒）
# statement_timeout = 30000

# 锁超时（毫秒）
# lock_timeout = 5000

# 空闲事务超时（毫秒）
# idle_in_transaction_session_timeout = 60000
