<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åœ°ç†ä½ç½®æµ‹è¯•</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
      font-size: 14px;
    }
    button:hover {
      background: #0056b3;
    }
    #output {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #007bff;
      padding-left: 10px;
    }
    .log-error {
      border-left-color: #ff4444;
      background: rgba(255, 68, 68, 0.1);
    }
    .log-success {
      border-left-color: #00cc66;
      background: rgba(0, 204, 102, 0.1);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§ª åœ°ç†ä½ç½®APIæµ‹è¯•å·¥å…·</h1>

    <div>
      <button onclick="testGeolocation()">ğŸŒ æµ‹è¯•æµè§ˆå™¨åœ°ç†ä½ç½®API</button>
      <button onclick="testAmapAPI()">ğŸ—ºï¸ æµ‹è¯•é«˜å¾·åœ°å›¾API</button>
      <button onclick="testBlinkoReverseGeocode()">ğŸ”„ æµ‹è¯•Blinkoé€†åœ°ç†ç¼–ç API</button>
      <button onclick="testBlinkoNearby()">ğŸ“ æµ‹è¯•Blinkoé™„è¿‘ä½ç½®API</button>
      <button onclick="clearOutput()">ğŸ§¹ æ¸…ç©ºè¾“å‡º</button>
    </div>

    <h2>è¾“å‡º</h2>
    <div id="output"></div>
  </div>

  <script>
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const output = document.getElementById('output');
      const entryDiv = document.createElement('div');
      entryDiv.className = `log-entry ${type === 'error' ? 'log-error' : type === 'success' ? 'log-success' : ''}`;
      entryDiv.textContent = `[${timestamp}] ${message}`;
      output.appendChild(entryDiv);
      output.scrollTop = output.scrollHeight;
    }

    function clearOutput() {
      document.getElementById('output').innerHTML = '';
      log('è¾“å‡ºå·²æ¸…ç©º');
    }

    async function testGeolocation() {
      log('=== æµ‹è¯•æµè§ˆå™¨åœ°ç†ä½ç½®API ===');

      if (!navigator.geolocation) {
        log('âŒ æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®API', 'error');
        return;
      }

      log('âœ… æµè§ˆå™¨æ”¯æŒåœ°ç†ä½ç½®API', 'success');

      log('æ­£åœ¨è¯·æ±‚ä½ç½®æƒé™...');
      navigator.geolocation.getCurrentPosition(
        (position) => {
          log('âœ… è·å–ä½ç½®æˆåŠŸï¼', 'success');
          log(`ç»åº¦: ${position.coords.longitude}`);
          log(`çº¬åº¦: ${position.coords.latitude}`);
          log(`ç²¾åº¦: ${position.coords.accuracy} ç±³`);

          // è°ƒç”¨é«˜å¾·åœ°å›¾APIè·å–åœ°å€
          testAmapAPI(position.coords.latitude, position.coords.longitude);
        },
        (error) => {
          log('âŒ è·å–ä½ç½®å¤±è´¥', 'error');
          log(`é”™è¯¯ä»£ç : ${error.code}`);
          log(`é”™è¯¯ä¿¡æ¯: ${getErrorMessage(error.code)}`);
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    }

    function getErrorMessage(code) {
      switch (code) {
        case 1:
          return 'ç”¨æˆ·æ‹’ç»äº†ä½ç½®è¯·æ±‚';
        case 2:
          return 'æ— æ³•è·å–ä½ç½®ä¿¡æ¯';
        case 3:
          return 'è·å–ä½ç½®è¶…æ—¶';
        default:
          return 'æœªçŸ¥é”™è¯¯';
      }
    }

    async function testAmapAPI(lat, lng) {
      log('\n=== æµ‹è¯•é«˜å¾·åœ°å›¾API ===');

      if (!lat || !lng) {
        log('ä½¿ç”¨é»˜è®¤åæ ‡ï¼ˆå¤©å®‰é—¨ï¼‰');
        lat = 39.90923;
        lng = 116.397428;
      }

      log(`åæ ‡: ${lng}, ${lat}`);

      const apiKey = 'ed4327e40666552c8f0d543748b18a38';
      const url = `https://restapi.amap.com/v3/geocode/regeo?key=${apiKey}&location=${lng},${lat}&radius=1000&extensions=all&poitype=000000`;

      log('æ­£åœ¨è°ƒç”¨é«˜å¾·åœ°å›¾é€†åœ°ç†ç¼–ç API...');

      try {
        const response = await fetch(url);
        const data = await response.json();

        log('âœ… APIè°ƒç”¨æˆåŠŸï¼', 'success');
        log(`çŠ¶æ€ç : ${data.status}`);
        log(`ä¿¡æ¯: ${data.info}`);

        if (data.status === '1') {
          const regeocode = data.regeocode;
          log(`æ ¼å¼åŒ–åœ°å€: ${regeocode.formatted_address}`);

          if (regeocode.aois && regeocode.aois.length > 0) {
            log(`AOI: ${regeocode.aois[0].name}`);
          }

          if (regeocode.pois && regeocode.pois.length > 0) {
            log(`POI: ${regeocode.pois[0].name}`);
          }
        } else {
          log(`âŒ APIè¿”å›é”™è¯¯: ${data.infocode}`, 'error');
        }
      } catch (error) {
        log(`âŒ APIè°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
      }
    }

    async function testBlinkoReverseGeocode() {
      log('\n=== æµ‹è¯•Blinkoé€†åœ°ç†ç¼–ç API ===');

      // é¦–å…ˆè·å–ä½ç½®
      navigator.geolocation.getCurrentPosition(
        async (position) => {
          log(`å½“å‰åæ ‡: ${position.coords.longitude}, ${position.coords.latitude}`);

          const url = 'http://localhost:1111/api/trpc/notes.reverseGeocode';
          const body = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude
          };

          log('æ­£åœ¨è°ƒç”¨Blinkoé€†åœ°ç†ç¼–ç API...');

          try {
            const response = await fetch(url, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(body)
            });

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();
            log('âœ… APIè°ƒç”¨æˆåŠŸï¼', 'success');
            log(`å“åº”æ•°æ®: ${JSON.stringify(data.result, null, 2)}`);
          } catch (error) {
            log(`âŒ APIè°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
          }
        },
        (error) => {
          log('âŒ æ— æ³•è·å–ä½ç½®ï¼Œè·³è¿‡æµ‹è¯•', 'error');
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    }

    async function testBlinkoNearby() {
      log('\n=== æµ‹è¯•Blinkoé™„è¿‘ä½ç½®API ===');

      // é¦–å…ˆè·å–ä½ç½®
      navigator.geolocation.getCurrentPosition(
        async (position) => {
          log(`å½“å‰åæ ‡: ${position.coords.longitude}, ${position.coords.latitude}`);

          const url = 'http://localhost:1111/api/trpc/notes.getNearbyLocations';
          const body = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude,
            radius: 500,
            pageSize: 10
          };

          log('æ­£åœ¨è°ƒç”¨Blinkoé™„è¿‘ä½ç½®API...');

          try {
            const response = await fetch(url, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(body)
            });

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();
            log('âœ… APIè°ƒç”¨æˆåŠŸï¼', 'success');
            log(`è¿”å› ${data.result?.length || 0} ä¸ªé™„è¿‘ä½ç½®`);

            if (data.result && data.result.length > 0) {
              data.result.forEach((location, index) => {
                log(`${index + 1}. ${location.name} - ${location.address}`);
              });
            }
          } catch (error) {
            log(`âŒ APIè°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
          }
        },
        (error) => {
          log('âŒ æ— æ³•è·å–ä½ç½®ï¼Œè·³è¿‡æµ‹è¯•', 'error');
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
    window.onload = function() {
      log('åœ°ç†ä½ç½®æµ‹è¯•å·¥å…·å·²åŠ è½½', 'info');
      log('è¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è¿›è¡Œæµ‹è¯•', 'info');
    };
  </script>
</body>
</html>
